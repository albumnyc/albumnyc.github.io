<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <script>
        function openDB(name, version) {
            var version = version || 1;
            var request = window.indexedDB.open(name, version);
            request.onerror = function(e) {
                console.log(e.currentTarget.error.message);
            };
            request.onsuccess = function(e) {
                myDB.db = e.target.result;
            };
            request.onupgradeneeded = function(e) { //////////////// db搞出来的功能
                var db = e.target.result;
                if (!db.objectStoreNames.contains('students')) {
                    var store = db.createObjectStore('students', {
                        keyPath: 'name',
                        autoIncrement: true
                    });
                    store.createIndex('nameIndex', 'name', {
                        unique: true
                    });
                    store.createIndex('ageIndex', 'age', {
                        unique: false
                    });
                }
                console.log('DB version changed to ' + version);
            };
        }
        var myDB = {
            name: 'test',
            version: 10,
            db: null
        };
        openDB(myDB.name, myDB.version);

        function closeDB(db) {
            db.close();
        }

        function deleteDB(name) {
            indexedDB.deleteDatabase(name);
        }

        var students = [{
            id: 1001,
            name: "Byron",
            age: 24
        }, {
            id: 1002,
            name: "Frank",
            age: 21
        }, {
            id: 1002,
            name: "Frand",
            age: 60
        }, {
            id: 1002,
            name: "Frdfsk",
            age: 29
        }, {
            id: 1002,
            name: "dfsgs",
            age: 25
        }, {
            id: 1002,
            name: "gesdg",
            age: 99
        }, {
            id: 1002,
            name: "wer",
            age: 35
        }, {
            id: 1002,
            name: "Frrewk",
            age: 33
        }, {
            id: 1003,
            name: "Aaron",
            age: 26
        }];
        // setTimeout(() => {
        //     var transaction = myDB.db.transaction('students', 'verionchange');
        //     var store = transaction.objectStore('students');
        // }, 30)


        function addData(db, storeName) {
            var transaction = db.transaction(storeName, 'readwrite');
            var store = transaction.objectStore(storeName);
            for (var i = 0; i < students.length; i++) {
                store.add(students[i]);
            }
        }
        openDB(myDB.name, myDB.version);
        // setTimeout(() => {}, 20)


        function getDataByKey(db, storeName, value) {
            var transaction = db.transaction(storeName, 'readwrite');
            var store = transaction.objectStore(storeName);
            var request = store.get(value);
            request.onsuccess = function(e) {
                var student = e.target.result;
                console.log(student.name);
            };
        }


        // function readAll() {
        //     var objectStore = myDB.db.transaction('students').objectStore('student');
        //     objectStore.openCursor().onsuccess = function(event) {
        //         var cursor = event.target.result;
        //         if (cursor) {
        //             console.log('Id: ' + cursor.key);
        //             console.log('Name: ' + cursor.value.name);
        //             console.log('Age: ' + cursor.value.age);
        //             console.log('Email: ' + cursor.value.email);
        //             cursor.continue();
        //         } else {
        //             console.log('没有更多数据了！');
        //         }
        //     };
        // }




        function updateDataByKey(db, storeName, value, newVal) {
            var transaction = db.transaction(storeName, 'readwrite');
            var store = transaction.objectStore(storeName);
            var request = store.get(value);
            request.onsuccess = function(e) {
                var student = e.target.result;
                student.age = newVal;
                store.put(student);
            };
        }

        function professionIndex(db, storeName, value, newVal) {
            var transaction = db.transaction(storeName, 'readwrite');
            var store = transaction.objectStore(storeName);
            // var request = store.get(value);
            let index = store.index('nameIndex');
            console.log(index.get('Aaron'));
            index.get('Aaron').onsuccess = (e) => {
                    const {
                        result
                    } = e.target;
                    console.log(result);
                    // delete result.name;
                    store.put(result);
                }
                // request.onsuccess = function(e) {
                //     var student = e.target.result;
                //     student.age = newVal;
                //     store.put(student);
                // };
        }

        function deleteDataByKey(db, storeName, value) {
            var transaction = db.transaction(storeName, 'readwrite');
            var store = transaction.objectStore(storeName);
            store.delete(value);
        }

        function clearObjectStore(db, storeName) {
            var transaction = db.transaction(storeName, 'readwrite');
            var store = transaction.objectStore(storeName);
            store.clear();
        }



        function fetchStoreByCursor(db, storeName) {
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var request = store.openCursor();
            request.onsuccess = function(e) {
                var cursor = e.target.result;
                if (cursor) {
                    console.log(cursor.key);
                    var currentStudent = cursor.value;
                    console.log(currentStudent.name);
                    cursor.continue();
                }
            };
        }

        function getMultipleData(db, storeName) {
            var transaction = db.transaction(storeName);
            var store = transaction.objectStore(storeName);
            var index = store.index("ageIndex");
            var request = index.openCursor(IDBKeyRange.only(30))
            request.onsuccess = function(e) {
                var cursor = e.target.result;
                if (cursor) {
                    var student = cursor.value;
                    console.log(student.id);
                    cursor.continue();
                }
            }
        }
        setTimeout(() => {
            addData(myDB.db, 'students');
            getDataByKey(myDB.db, 'students', 'Aaron');
            updateDataByKey(myDB.db, 'students', 'Byron', 'Aaron');
            professionIndex(myDB.db, 'students', 'Byron', 'Aaron');
            getDataByKey(myDB.db, 'students', 'Aaron');
            fetchStoreByCursor(myDB.db, 'students');
            getMultipleData(myDB.db, 'students');
        }, 30)
    </script>
</body>

</html>